<html>
<script type="text/javascript" src="console.js"></script>
<script type="text/javascript" src="pwapi.js"></script>
<script type="text/javascript" src="json.js"></script>
<script type="text/javascript" src="cache.js"></script>
<script type="text/javascript" src="stores.js"></script>
<script type="text/javascript" src="unit_tests.js"></script>
<script type="text/javascript">

/*
JSONWrapper = JSONWrapper();

JSONWrapper.set_toString(JSON.stringify);
JSONWrapper.set_fromString(JSON.parse);

var foo = {
  bar: 3
};

console.log(foo);
var jsoned = JSONWrapper.toString(foo);
console.log(jsoned);
console.log(JSONWrapper.fromString(jsoned));
*/


/**/
runStoreUnitTests();
runCacheGetSetUnitTests(cache);
runCacheUpdateUnitTests(cache);
/**/

//console.log(window);

/**
// set up our store as the best available option
if(localStorage) {
  // use localStorage; persistent until...?
  var store = localStorageStore;
} else if(document.cookie) {
  // use cookies; persistent across sessions until cookies are cleared
  var store = cookiejarStore;
} else {
  // :( just use a per-pageload array in memory
  var store = arrayStore;
}
/**/

/**

cache = cache();
cache.setStore(arrayStore);

var tomorrow = new Date();
tomorrow.setTime(tomorrow.getTime() + (1000*3600*24));
var yesterday = new Date();
yesterday.setTime(yesterday.getTime() - (1000*3600*24));

console.log("=Before setting on this page=");
var tests = ["noSuchKey","infiniteKey","yesterdayKey","tomorrowKey"];
for(i=0 ; i<tests.length ; i++) {
  console.log(tests[i]+" val={"+cache.get(tests[i])+"}, expires={"+cache.getExpiry(tests[i])+"}");
}

cache.set("infiniteKey","this never expires");
cache.set("yesterdayKey","this expired yesterday", yesterday);
cache.set("tomorrowKey","this expires tomorrow", tomorrow);

console.log("=After setting on this page==");
var tests = ["noSuchKey","infiniteKey","yesterdayKey","tomorrowKey"];
for(i=0 ; i<tests.length ; i++) {
  console.log(tests[i]+" val={"+cache.get(tests[i])+"}, expires={"+cache.getExpiry(tests[i])+"}");
}

console.log("=Some jiggerypokery==");

// will still have same expiry
cache.set("tomorrowKey","updated value only");
console.log("tomorrowKey(updated value only)"+" val={"+cache.get("tomorrowKey")+"}, expires={"+cache.getExpiry("tomorrowKey")+"}");

// will be infinite
cache.set("tomorrowKey","this expires never", false);
console.log("tomorrowKey(updated for no expiry)"+" val={"+cache.get("tomorrowKey")+"}, expires={"+cache.getExpiry("tomorrowKey")+"}");

// will be null
cache.set("tomorrowKey","this expires tomorrow", yesterday);
console.log("tomorrowKey(updated for yesterday expiry)"+" val={"+cache.get("tomorrowKey")+"}, expires={"+cache.getExpiry("tomorrowKey")+"}");

// will update infiniteKey to expire tomorrow
cache.setExpiry("infiniteKey", tomorrow);
console.log("infiniteKey(updated to tomorrow)"+" val={"+cache.get("infiniteKey")+"}, expires={"+cache.getExpiry("infiniteKey")+"}");

// will be NULL:
cache.setExpiry("noSuchKey", tomorrow);
console.log("noSuchKey(updated to tomorrow)"+" val={"+cache.get("noSuchKey")+"}, expires={"+cache.getExpiry("noSuchKey")+"}");

/**/

/*
pwAPI.set_cache_handler(cache);

pwAPI.set_token("sdsf");

pwAPI._get_cache_handler()._dump_store();

pwAPI.get_prices();
*/
</script>
<textarea rows=100 cols=100 id="console"></textarea>
</html>